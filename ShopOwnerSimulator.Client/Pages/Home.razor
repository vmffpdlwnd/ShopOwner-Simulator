@page "/"
@using ShopOwnerSimulator.Client.Services
@using ShopOwnerSimulator.Client.Models
@inject PlayFabService PlayFabService

<PageTitle>ShopOwner Simulator</PageTitle>

<div class="container mt-5">
    <h1>ShopOwner Simulator</h1>
    <p>던전에서 얻은 아이템을 판매하는 상점 시뮬레이터</p>

    @if (currentUser == null)
    {
        <div class="card mt-4">
            <div class="card-body">
                <h3>새 게임 시작</h3>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" @bind="username" placeholder="유저명 입력" />
                    <button class="btn btn-primary" @onclick="CreateNewUser">게임 시작</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card mt-4">
            <div class="card-body">
                <h3>환영합니다, @currentUser.Username!</h3>
                <p>레벨: @currentUser.Level</p>
                <p>골드: @currentUser.Gold</p>
                <p>마지막 로그인: @currentUser.LastLoginAt.ToLocalTime()</p>
                <button class="btn btn-success" @onclick="StartGame">게임 진입</button>
            </div>
        </div>
    }
</div>

@code {
    private string username = "";
    private User? currentUser;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        // 이미 로그인된 상태라면 사용자 데이터 로드
        if (PlayFabService.IsAuthenticated)
        {
            currentUser = await PlayFabService.LoadUserDataAsync();
        }
    }

    private async Task CreateNewUser()
    {
        if (string.IsNullOrWhiteSpace(username))
        {
            errorMessage = "유저명을 입력해주세요.";
            return;
        }

        // PlayFab 계정 생성 및 로그인
        var success = await PlayFabService.CreateAccountAsync(username);
        
        if (success)
        {
            currentUser = await PlayFabService.LoadUserDataAsync();
            errorMessage = "";
        }
        else
        {
            // 이미 존재하는 계정이면 로그인 시도
            success = await PlayFabService.LoginAsync(username);
            if (success)
            {
                currentUser = await PlayFabService.LoadUserDataAsync();
                errorMessage = "";
            }
            else
            {
                errorMessage = "유저 생성/로그인에 실패했습니다.";
            }
        }
    }

    private void StartGame()
    {
        // TODO: 게임 화면으로 이동
        errorMessage = "게임 화면은 아직 구현 중입니다.";
    }
}
