@page "/"
@using ShopOwnerSimulator.Client.Services
@using ShopOwnerSimulator.Client.Models
@inject ApiService ApiService

<PageTitle>ShopOwner Simulator</PageTitle>

<div class="container mt-5">
    <h1>ShopOwner Simulator</h1>
    <p>던전에서 얻은 아이템을 판매하는 상점 시뮬레이터</p>

    @if (currentUser == null)
    {
        <div class="card mt-4">
            <div class="card-body">
                <h3>새 게임 시작</h3>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" @bind="username" placeholder="유저명 입력" />
                    <button class="btn btn-primary" @onclick="CreateNewUser">게임 시작</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card mt-4">
            <div class="card-body">
                <h3>환영합니다, @currentUser.Username!</h3>
                <p>레벨: @currentUser.Level</p>
                <p>골드: @currentUser.Gold</p>
                <p>마지막 로그인: @currentUser.LastLoginAt.ToLocalTime()</p>
                <button class="btn btn-success" @onclick="StartGame">게임 진입</button>
            </div>
        </div>
    }
</div>

@code {
    private string username = "";
    private User? currentUser;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        currentUser = await ApiService.GetCurrentUserAsync();
    }

    private async Task CreateNewUser()
    {
        if (string.IsNullOrWhiteSpace(username))
        {
            errorMessage = "유저명을 입력해주세요.";
            return;
        }

        currentUser = await ApiService.CreateNewUserAsync(username);
        if (currentUser == null)
        {
            errorMessage = "유저 생성에 실패했습니다.";
        }
        else
        {
            errorMessage = "";
        }
    }

    private void StartGame()
    {
        // TODO: 게임 화면으로 이동
        errorMessage = "게임 화면은 아직 구현 중입니다.";
    }
}
