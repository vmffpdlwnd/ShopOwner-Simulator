@page "/"
@implements IAsyncDisposable
@using ShopOwnerSimulator.State
@using ShopOwnerSimulator.Models.Entities
@inject GameState GameState
@inject NavigationManager Navigation

<PageTitle>ëŒ€ì‹œë³´ë“œ - ìƒì ì£¼ì¸ ì‹œë®¬ë ˆì´í„°</PageTitle>

<div class="dashboard-container">
    <div class="dashboard-grid">
        <!-- Settlement Report -->
        <div class="card settlement-card">
            <h2>ì˜¤ëŠ˜ì˜ ì •ì‚°</h2>
            <div class="settlement-details">
                <div class="stat-row">
                    <span>ì´ ê³¨ë“œ</span>
                    <span class="amount">@GameState.Player?.Gold.ToString("N0")</span>
                </div>
                <div class="stat-row">
                    <span>ì˜¤ëŠ˜ì˜ ìˆ˜ìµ</span>
                    <span class="amount positive">+@CalculateTodayEarnings().ToString("N0")</span>
                </div>
                <div class="stat-row">
                    <span>ë ˆë²¨</span>
                    <span>@GameState.Player?.Level</span>
                </div>
            </div>
        </div>

        <!-- Hot Items -->
        <div class="card hot-items-card">
            <h2>ğŸ”¥ ì¸ê¸° ì•„ì´í…œ</h2>
            <div class="items-list">
                @foreach (var item in GetTrendingItems())
                {
                    <div class="item-trend">
                        <span class="item-name">@item.Name</span>
                        <span class="price-change positive">+@($"{item.PriceChange}%")</span>
                    </div>
                }
            </div>
        </div>

        <!-- Mercenary Status -->
        <div class="card mercenary-card">
            <h2>ìš©ë³‘ ìƒíƒœ</h2>
            <div class="mercenary-list">
                @if (GameState.Mercenaries != null && GameState.Mercenaries.Count > 0)
                {
                    @foreach (var merc in GameState.Mercenaries.Take(3))
                    {
                        <div class="merc-item">
                            <div class="merc-info">
                                <div class="merc-name">@merc.Name</div>
                                <div class="merc-level">ë ˆë²¨ @merc.Level</div>
                            </div>
                            @if (merc.CurrentDungeonId != null)
                            {
                                <div class="merc-status">
                                    <span class="status-badge mining">ì±„êµ´ì¤‘...</span>
                                    <Timer EndTime="merc.DungeonEndTime" />
                                </div>
                            }
                            else
                            {
                                <div class="merc-status">
                                    <span class="status-badge idle">ëŒ€ê¸°ì¤‘</span>
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <p class="empty-state">ì•„ì§ ìš©ë³‘ì´ ì—†ìŠµë‹ˆë‹¤</p>
                }
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card actions-card">
            <h2>ë¹ ë¥¸ ì‘ì—…</h2>
            <div class="actions-grid">
                <button class="action-btn" @onclick='() => Navigation.NavigateTo("/mining")'>
                    <span class="icon">â›ï¸</span>
                    <span>ì±„êµ´ ì‹œì‘</span>
                </button>
                <button class="action-btn" @onclick='() => Navigation.NavigateTo("/crafting")'>
                    <span class="icon">ğŸ”¨</span>
                    <span>ì•„ì´í…œ ì œì‘</span>
                </button>
                <button class="action-btn" @onclick='() => Navigation.NavigateTo("/exchange")'>
                    <span class="icon">ğŸ“ˆ</span>
                    <span>ê±°ë˜ì†Œ í™•ì¸</span>
                </button>
                <button class="action-btn" @onclick='() => Navigation.NavigateTo("/mercenary")'>
                    <span class="icon">âš”ï¸</span>
                    <span>ìš©ë³‘ ê³ ìš©</span>
                </button>
            </div>
        </div>

        <!-- Inventory Preview -->
        <div class="card inventory-card">
            <h2>ì¸ë²¤í† ë¦¬</h2>
            <div class="inventory-preview">
                @if (GameState.Inventory != null && GameState.Inventory.Count > 0)
                {
                    @foreach (var item in GameState.Inventory.Take(5))
                    {
                        <div class="inv-item">
                            <span class="item-name">@item.ItemTemplateId</span>
                            <span class="item-qty">x@item.Quantity</span>
                        </div>
                    }
                    @if (GameState.Inventory.Count > 5)
                    {
                        <div class="inv-more">
                            +@(GameState.Inventory.Count - 5)ê°œ ë”ë³´ê¸°
                        </div>
                    }
                }
                else
                {
                    <p class="empty-state">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</p>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        padding: 2rem;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
    }

    .card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .card h2 {
        margin: 0 0 1.5rem 0;
        font-size: 1.25rem;
        color: #333;
    }

    .settlement-details .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }

    .settlement-details .stat-row:last-child {
        border-bottom: none;
    }

    .amount {
        font-weight: bold;
        font-size: 1.1rem;
    }

    .amount.positive {
        color: #28a745;
    }

    .items-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .item-trend {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
    }

    .item-name {
        font-weight: 500;
    }

    .price-change {
        font-weight: bold;
    }

    .price-change.positive {
        color: #28a745;
    }

    .mercenary-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .merc-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border-left: 4px solid #007bff;
    }

    .merc-info {
        flex: 1;
    }

    .merc-name {
        font-weight: 600;
        color: #333;
    }

    .merc-level {
        font-size: 0.875rem;
        color: #666;
    }

    .merc-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-badge.mining {
        background: #ffc107;
        color: #333;
    }

    .status-badge.idle {
        background: #28a745;
        color: white;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .action-btn .icon {
        font-size: 1.5rem;
    }

    .inventory-preview {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .inv-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    .item-qty {
        font-weight: 600;
        color: #007bff;
    }

    .inv-more {
        padding: 0.75rem;
        color: #666;
        font-size: 0.875rem;
        font-style: italic;
    }

    .empty-state {
        color: #999;
        text-align: center;
        padding: 1rem;
    }
</style>

@code {
    protected override async Task OnInitializedAsync()
    {
        GameState.OnStateChanged += StateHasChanged;
        await base.OnInitializedAsync();
    }

    private long CalculateTodayEarnings()
    {
        // Mock calculation - in real app, fetch from transaction history
        return 0;
    }

    private List<(string Name, int PriceChange)> GetTrendingItems()
    {
        return new()
        {
            ("ì² ê´‘ì„", 15),
            ("ëª©ì¬", 8),
            ("ì²  ê²€", 22),
            ("ê°€ì£½ ê°‘ì˜·", 5)
        };
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        GameState.OnStateChanged -= StateHasChanged;
    }
}