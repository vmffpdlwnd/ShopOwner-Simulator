@page "/login"
@implements IAsyncDisposable
@using ShopOwnerSimulator.State
@using ShopOwnerSimulator.Services
@using Microsoft.JSInterop
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Web
@inject GameState GameState
@inject IPlayFabService PlayFabService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>ë¡œê·¸ì¸ - Shop Owner Simulator</PageTitle>

<div class="login-container">
    <div class="login-box">
        <div class="login-header">
            <h1>ğŸª ìƒì ì£¼ì¸ ì‹œë®¬ë ˆì´í„°</h1>
            <p class="tagline">ë‹¹ì‹ ë§Œì˜ ê±°ë˜ ì œêµ­ì„ ê±´ì„¤í•˜ì„¸ìš”</p>
        </div>

        @if (IsGuestMode)
        {
            <div class="guest-mode">
                <div class="mode-switch">
                    <button class="mode-btn" @onclick="() => IsGuestMode = false">ê³„ì • ë¡œê·¸ì¸</button>
                </div>
                
                <div class="guest-info">
                    <h3>ğŸ® ê²ŒìŠ¤íŠ¸ë¡œ í”Œë ˆì´</h3>
                    <p>ë¡œê·¸ì¸ ì—†ì´ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”. ë°ì´í„°ëŠ” ì´ ê¸°ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                    <p class="warning">âš ï¸ ë¸Œë¼ìš°ì € ë°ì´í„° ì‚­ì œ ì‹œ ì§„í–‰ ìƒí™©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
                </div>

                <button class="btn btn-guest" @onclick="LoginAsGuest" disabled="@IsLoading">
                    @(IsLoading ? "ì‹œì‘ ì¤‘..." : "ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°")
                </button>
            </div>
        }
        else
        {
            <div class="account-mode">
                <div class="mode-switch">
                    <button class="mode-btn" @onclick="() => IsGuestMode = true">ê²ŒìŠ¤íŠ¸ë¡œ í”Œë ˆì´</button>
                </div>

                <div class="login-tabs">
                    <button class="tab @(IsRegisterMode ? "" : "active")" @onclick="() => IsRegisterMode = false">
                        ë¡œê·¸ì¸
                    </button>
                    <button class="tab @(IsRegisterMode ? "active" : "")" @onclick="() => IsRegisterMode = true">
                        íšŒì›ê°€ì…
                    </button>
                </div>

                <div class="login-form">
                    @if (IsRegisterMode)
                    {
                        <div class="form-group">
                            <label>ì‚¬ìš©ìëª…</label>
                            <input type="text" @bind="Username" class="form-control" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
                        </div>
                    }

                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" @bind="Email" class="form-control" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    </div>

                    <div class="form-group">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" @bind="Password" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
                            @onkeyup="OnPasswordKeyUp">
                    </div>

                    @if (IsRegisterMode)
                    {
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" @bind="PasswordConfirm" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
                        </div>
                    }

                    <button class="btn btn-login" @onclick="LoginOrRegister" disabled="@IsLoading">
                        @(IsLoading ? "ì²˜ë¦¬ ì¤‘..." : IsRegisterMode ? "íšŒì›ê°€ì…" : "ë¡œê·¸ì¸")
                    </button>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="error-message">
                            @ErrorMessage
                        </div>
                    }
                </div>
            </div>
        }

        <div class="login-features">
            <h3>ë¬´ì—‡ì„ í•  ìˆ˜ ìˆë‚˜ìš”?</h3>
            <ul class="feature-list">
                <li>â›ï¸ ë˜ì „ì„ íƒí—˜í•˜ê³  ìš©ë³‘ì„ ê´€ë¦¬í•˜ì„¸ìš”</li>
                <li>ğŸ”¨ ê°•ë ¥í•œ ì¥ë¹„ë¥¼ ì œì‘í•˜ì„¸ìš”</li>
                <li>ğŸ’¼ ê°œì¸ ìƒì ì„ ìš´ì˜í•˜ì„¸ìš”</li>
                <li>ğŸ“ˆ í”Œë ˆì´ì–´ ê±°ë˜ì†Œì—ì„œ ê±°ë˜í•˜ì„¸ìš”</li>
                <li>âš”ï¸ íŒ€ì„ êµ¬ì¶•í•˜ê³  ê°•í™”í•˜ì„¸ìš”</li>
                <li>ğŸ’° ë¶€ì™€ ê¶Œë ¥ì„ ìŒ“ìœ¼ì„¸ìš”</li>
            </ul>
        </div>

        <div class="login-footer">
            <p class="version">Version 1.0.0</p>
            <p class="privacy">PlayFabì„ í†µí•´ ì•ˆì „í•˜ê²Œ ë°ì´í„°ê°€ ì €ì¥ë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <div class="background-animation">
        <div class="float-item item-1">â›ï¸</div>
        <div class="float-item item-2">ğŸ’¼</div>
        <div class="float-item item-3">ğŸ”¨</div>
        <div class="float-item item-4">ğŸ“ˆ</div>
        <div class="float-item item-5">âš”ï¸</div>
        <div class="float-item item-6">ğŸ’°</div>
    </div>
</div>

<style>
    .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: relative;
        overflow: hidden;
    }

    .background-animation {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
    }

    .float-item {
        position: absolute;
        font-size: 4rem;
        opacity: 0.1;
        animation: float infinite ease-in-out;
    }

    .float-item.item-1 { top: 10%; left: 10%; animation-duration: 6s; }
    .float-item.item-2 { top: 20%; right: 15%; animation-duration: 7s; animation-delay: 1s; }
    .float-item.item-3 { bottom: 20%; left: 20%; animation-duration: 8s; animation-delay: 2s; }
    .float-item.item-4 { top: 30%; right: 5%; animation-duration: 9s; animation-delay: 0.5s; }
    .float-item.item-5 { bottom: 30%; right: 20%; animation-duration: 10s; animation-delay: 1.5s; }
    .float-item.item-6 { top: 50%; left: 5%; animation-duration: 7.5s; animation-delay: 2.5s; }

    @@keyframes float {
        0%, 100% { transform: translateY(0px) translateX(0px); }
        50% { transform: translateY(-30px) translateX(20px); }
    }

    .login-box {
        background: white;
        border-radius: 1rem;
        padding: 3rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 450px;
        width: 100%;
        z-index: 10;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }

    .login-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .login-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.8rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .tagline {
        margin: 0;
        color: #666;
        font-size: 0.95rem;
    }

    .mode-switch {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .mode-btn {
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 0.5rem 1.5rem;
        border-radius: 2rem;
        cursor: pointer;
        font-size: 0.875rem;
        color: #666;
        transition: all 0.2s;
    }

    .mode-btn:hover {
        background: #e9ecef;
        color: #333;
    }

    .guest-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .guest-info h3 {
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        color: #0056b3;
    }

    .guest-info p {
        margin: 0 0 0.5rem 0;
        font-size: 0.875rem;
        color: #666;
        line-height: 1.5;
    }

    .guest-info .warning {
        color: #856404;
        font-weight: 600;
    }

    .login-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 2rem;
        border-bottom: 2px solid #eee;
    }

    .tab {
        flex: 1;
        padding: 0.75rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #999;
        transition: all 0.2s;
    }

    .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }

    .login-form {
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
        font-size: 0.95rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #ddd;
        border-radius: 0.5rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        width: 100%;
        padding: 1rem;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-login {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-guest {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .error-message {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 0.5rem;
        font-size: 0.875rem;
    }

    .login-features {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .login-features h3 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: #333;
    }

    .feature-list {
        margin: 0;
        padding-left: 0;
        list-style: none;
    }

    .feature-list li {
        padding: 0.5rem 0;
        color: #666;
        font-size: 0.9rem;
    }

    .login-footer {
        text-align: center;
        border-top: 1px solid #eee;
        padding-top: 1rem;
    }

    .version, .privacy {
        margin: 0.25rem 0;
        font-size: 0.75rem;
        color: #999;
    }

    @@media (max-width: 600px) {
        .login-box {
            margin: 1rem;
            padding: 2rem 1.5rem;
        }
        .login-header h1 {
            font-size: 1.5rem;
        }
        .float-item {
            font-size: 3rem;
        }
    }
</style>

@code {
    private bool IsGuestMode = true;
    private bool IsRegisterMode = false;
    private string Username = "";
    private string Email = "";
    private string Password = "";
    private string PasswordConfirm = "";
    private bool IsLoading = false;
    private string ErrorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        if (GameState.IsInitialized)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task LoginAsGuest()
    {
        IsLoading = true;
        ErrorMessage = "";

        try
        {
            var deviceId = GetOrCreateDeviceId();

            // Create a local, ephemeral guest player (no server calls). Data will be kept
            // only in-memory for this session and reset when the page is reloaded.
            var guestPlayer = new ShopOwnerSimulator.Models.Entities.Player
            {
                Id = $"guest_{deviceId}",
                Username = "ê²ŒìŠ¤íŠ¸",
                Level = 1,
                Experience = 0,
                Gold = 1000,
                Crystal = 0,
                CreatedAt = DateTime.UtcNow,
                LastLoginAt = DateTime.UtcNow
            };

            await GameState.InitializeGuestAsync(guestPlayer);
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì‹¤íŒ¨: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoginOrRegister()
    {
        if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
        {
            ErrorMessage = "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
            return;
        }

        if (IsRegisterMode)
        {
            if (string.IsNullOrWhiteSpace(Username))
            {
                ErrorMessage = "ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”";
                return;
            }

            if (Password != PasswordConfirm)
            {
                ErrorMessage = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤";
                return;
            }

            await Register();
        }
        else
        {
            await PerformLoginAsync();
        }
    }

    private async Task PerformLoginAsync()
    {
        IsLoading = true;
        ErrorMessage = "";

        try
        {
            var playerId = await PlayFabService.LoginWithEmailAsync(Email, Password);
            await GameState.InitializeAsync();
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Login error: {ex}");
            ErrorMessage = $"ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Register()
    {
        IsLoading = true;
        ErrorMessage = "";

        try
        {
            var playerId = await PlayFabService.RegisterWithEmailAsync(Email, Password, Username);
            await GameState.InitializeAsync();
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Register error: {ex}");

            // Prefer the outer exception message (PlayFabService may provide a localized message)
            var payload = ex.Message;

            // If inner exception contains a JSON payload, try to parse and extract details.
            var inner = ex.InnerException?.Message;
            if (!string.IsNullOrEmpty(inner) && inner.TrimStart().StartsWith("{"))
            {
                try
                {
                    using var doc = JsonDocument.Parse(inner);
                    if (doc.RootElement.TryGetProperty("errorMessage", out var em))
                    {
                        payload = $"íšŒì›ê°€ì… ì‹¤íŒ¨: {em.GetString()}";
                    }
                    else if (doc.RootElement.TryGetProperty("errorDetails", out var ed) && ed.TryGetProperty("Username", out var u))
                    {
                        if (u.ValueKind == JsonValueKind.Array && u.GetArrayLength() > 0)
                            payload = $"íšŒì›ê°€ì… ì‹¤íŒ¨: {u[0].GetString()}";
                        else
                            payload = "íšŒì›ê°€ì… ì‹¤íŒ¨: ì…ë ¥ê°’ì„ í™•ì¸í•˜ì„¸ìš”";
                    }
                    else
                    {
                        payload = "íšŒì›ê°€ì… ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";
                    }
                }
                catch
                {
                    // If parsing fails, keep outer message
                }
            }

            // Show the best available message to user
            ErrorMessage = payload;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetOrCreateDeviceId()
    {
        try
        {
            var deviceId = JSRuntime.InvokeAsync<string>("ShopOwnerSimulator.getLocalStorage", "deviceId").Result;
            if (string.IsNullOrEmpty(deviceId))
            {
                deviceId = Guid.NewGuid().ToString();
                JSRuntime.InvokeVoidAsync("ShopOwnerSimulator.setLocalStorage", "deviceId", deviceId);
            }
            return deviceId;
        }
        catch
        {
            return Guid.NewGuid().ToString();
        }
    }

    private void OnPasswordKeyUp(KeyboardEventArgs e)
    {
        if (e?.Key == "Enter")
        {
            _ = LoginOrRegister();
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync() { }
}