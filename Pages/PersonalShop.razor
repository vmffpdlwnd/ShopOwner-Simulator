@page "/personal-shop"
@implements IAsyncDisposable
@using ShopOwnerSimulator.Services
@using ShopOwnerSimulator.Models.DTOs
@using ShopOwnerSimulator.State
@inject GameState GameState
@inject IPersonalShopService PersonalShopService

<PageTitle>개인상점 - 상점주인 시뮬레이터</PageTitle>

<div class="personal-shop-container">
    <h1>개인 상점</h1>

    <div class="shop-content">
        <!-- Active Listings -->
        <div class="listings-panel">
            <h2>판매중인 상품</h2>
            <div class="listings-list">
                @if (ActiveListings != null && ActiveListings.Count > 0)
                {
                    @foreach (var listing in ActiveListings)
                    {
                        <div class="listing-card">
                            <div class="listing-header">
                                <h3>@ShopOwnerSimulator.Utils.FormatHelper.GetItemDisplayName(listing.ItemTemplateId)</h3>
                                <span class="price">@listing.UnitPrice G each</span>
                            </div>
                            <div class="listing-details">
                                <div class="detail-row">
                                    <span>수량</span>
                                    <span class="value">@listing.Quantity</span>
                                </div>
                                <div class="detail-row">
                                    <span>총 가격</span>
                                    <span class="value">@listing.TotalGoldOnSale G</span>
                                </div>
                                <div class="detail-row">
                                    <span>등록일</span>
                                    <span class="value">@listing.ListedTime.ToString("MMM dd HH:mm")</span>
                                </div>
                                <div class="detail-row">
                                    <span>만료</span>
                                    <Timer EndTime="listing.ExpireTime" />
                                </div>
                            </div>
                            <button class="btn btn-danger" @onclick="() => CancelListing(listing.Id)">
                                취소
                            </button>
                        </div>
                    }
                }
                else
                {
                    <p class="empty">판매중인 상품이 없습니다</p>
                }
            </div>
        </div>

        <!-- New Listing Form -->
        <div class="list-form-panel">
            <h2>새 상품 등록</h2>
            <div class="form-section">
                <div class="form-group">
                    <label>아이템 선택</label>
                    <select @onchange="e => FormItem = e.Value.ToString()" class="form-control">
                        <option value="">아이템 선택...</option>
                        @if (GameState.Inventory != null)
                        {
                            @foreach (var item in GameState.Inventory.Where(i => !i.IsEquipped))
                            {
                                <option value="@item.ItemTemplateId">@ShopOwnerSimulator.Utils.FormatHelper.GetItemDisplayName(item.ItemTemplateId) (x@(item.Quantity))</option>
                            }
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>수량</label>
                    <input type="number" min="1" @bind="FormQuantity" class="form-control" placeholder="수량?">
                </div>

                <div class="form-group">
                    <label>단가</label>
                    <div class="price-input">
                        <input type="number" min="1" @bind="FormPrice" class="form-control" placeholder="가격">
                        <span class="currency">G</span>
                    </div>
                    <small class="calc">총액: @(FormQuantity * FormPrice) G</small>
                </div>

                <div class="form-group">
                    <label>자동 판매 시간</label>
                    <select @onchange="e => FormExpireHours = int.Parse(e.Value.ToString())" class="form-control">
                        <option value="1">1시간</option>
                        <option value="6">6시간</option>
                        <option value="12">12시간</option>
                        <option value="24" selected>24시간</option>
                        <option value="48">48시간</option>
                    </select>
                </div>

                <button class="btn btn-primary" @onclick="CreateListing" disabled="@(string.IsNullOrEmpty(FormItem))">
                    상품 등록
                </button>
            </div>

            <h2 style="margin-top: 2rem;">판매 완료</h2>
            <div class="sold-list">
                @if (SoldListings != null && SoldListings.Count > 0)
                {
                    @foreach (var listing in SoldListings)
                    {
                        <div class="sold-item">
                            <div class="sold-info">
                                <span class="item-name">@ShopOwnerSimulator.Utils.FormatHelper.GetItemDisplayName(listing.ItemTemplateId)</span>
                                <span class="item-qty">x@(listing.Quantity)</span>
                            </div>
                            <div class="sold-value">
                                <span class="gold-earned">+@listing.TotalGoldOnSale G</span>
                                <span class="sold-time">@listing.ListedTime.ToString("MMM dd")</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="empty">판매 완료된 아이템이 없습니다</p>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .personal-shop-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .personal-shop-container h1 {
        margin-bottom: 2rem;
        font-size: 2rem;
        color: #333;
    }

    .shop-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .listings-panel,
    .list-form-panel {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .listings-panel h2,
    .list-form-panel h2 {
        margin: 0 0 1.5rem 0;
        font-size: 1.25rem;
        color: #333;
    }

    .listings-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .listing-card {
        border: 2px solid #ffc107;
        border-radius: 0.5rem;
        padding: 1rem;
        background: rgba(255, 193, 7, 0.05);
    }

    .listing-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .listing-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #333;
    }

    .price {
        background: #ffc107;
        color: #333;
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .listing-details {
        margin-bottom: 1rem;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.875rem;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .value {
        font-weight: 600;
        color: #ffc107;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #007bff;
        color: white;
        width: 100%;
    }

    .btn-primary:hover:not(:disabled) {
        background: #0056b3;
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
        width: 100%;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .form-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .price-input {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .price-input .form-control {
        flex: 1;
    }

    .currency {
        font-weight: 600;
        color: #666;
    }

    .calc {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #666;
    }

    .sold-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .sold-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border: 1px solid #d4edda;
        border-radius: 0.5rem;
        background: rgba(40, 167, 69, 0.05);
    }

    .sold-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .item-name {
        font-weight: 600;
        color: #333;
    }

    .item-qty {
        font-size: 0.75rem;
        color: #666;
    }

    .sold-value {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
    }

    .gold-earned {
        font-weight: 600;
        color: #28a745;
        font-size: 0.95rem;
    }

    .sold-time {
        font-size: 0.75rem;
        color: #666;
    }

    .empty {
        color: #999;
        text-align: center;
        padding: 1.5rem;
    }

    @@media (max-width: 1024px) {
        .shop-content {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private List<ShopOwnerSimulator.Models.Entities.PersonalShopListing> ActiveListings = new();
    private List<ShopOwnerSimulator.Models.Entities.PersonalShopListing> SoldListings = new();
    
    private string FormItem = "";
    private int FormQuantity = 1;
    private long FormPrice = 100;
    private int FormExpireHours = 24;

    protected override async Task OnInitializedAsync()
    {
        GameState.OnStateChanged += StateHasChanged;
        await LoadListings();
    }

    private async Task LoadListings()
    {
        try
        {
            var allListings = await PersonalShopService.GetMyListingsAsync(GameState.Player?.Id ?? "");
            ActiveListings = allListings.Where(l => l.Status == ShopOwnerSimulator.Models.Entities.ListingStatus.Active).ToList();
            SoldListings = allListings.Where(l => l.Status == ShopOwnerSimulator.Models.Entities.ListingStatus.Sold).ToList();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading listings: {ex.Message}");
        }
    }

    private async Task CreateListing()
    {
        try
        {
            var request = new PersonalShopListRequest
            {
                ItemTemplateId = FormItem,
                Quantity = FormQuantity,
                UnitPrice = FormPrice,
                ExpireHours = FormExpireHours
            };

            await PersonalShopService.ListItemAsync(request);
            await GameState.LoadGameStateAsync();
            await LoadListings();

            FormItem = "";
            FormQuantity = 1;
            FormPrice = 100;
            FormExpireHours = 24;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error creating listing: {ex.Message}");
        }
    }

    private async Task CancelListing(string listingId)
    {
        try
        {
            await PersonalShopService.CancelListingAsync(listingId);
            await GameState.LoadGameStateAsync();
            await LoadListings();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error canceling listing: {ex.Message}");
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        GameState.OnStateChanged -= StateHasChanged;
    }
}